<!DOCTYPE html>
<html lang="fr">
<head>
    <!--
    Process:
    * Add component :
     - Add MY COMPONENT to the HTML group : <button class="btn-js" onclick="addBlock('MY COMPONENT')">MY COMPONENT</button>
     - Update getDefaultContent to provide default content :
        ```
        function getDefaultContent(type) {
            const defaults = {
                'MY COMPONENT': '<script>console.log("MY COMPONENT loaded");</script>',
                'MY COMPONENT': '<script src="https://cdn.MYCOMPONENT.com/library.js"></script>',
                // Autres valeurs par défaut pour les autres blocs
            };
            return defaults[type] || '';
        }
        ```
     - Update GenerateHTML to include MY COMPONENT in the correct HTML section
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fusko</title>
    <style>
        /* Styles de base */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { display: flex; height: 100vh; overflow: hidden; }
        #builder, #preview { width: 50%; padding: 10px; overflow-y: auto; }
        #builder { background-color: #f0f4ff; border-right: 2px solid #ccc; }
        #preview { background-color: #fff; }
        h2 { margin-bottom: 10px; font-size: 1.5rem; color: #333; }
        
        /* Boutons de création regroupés */
        .button-group {
            margin-bottom: 10px;
        }
        .button-group h3 {
            margin-bottom: 5px;
            font-size: 1.2rem;
            color: #555;
        }
        .button-group .btn-html {
            background-color: #337ab7; /* Bleu pour HTML */
        }
        .button-group .btn-css {
            background-color: #5cb85c; /* Vert pour CSS */
        }
        .button-group .btn-js {
            background-color: #f0ad4e; /* Orange pour JS */
        }
        .button-group .btn-custom {
            background-color: #5f9ea0; /* Couleur actuelle pour Custom */
        }
        .button-group button {
            padding: 10px;
            margin: 5px 5px 5px 0;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            color: #fff;
            border-radius: 5px;
        }
        
        /* Bouton Reset spécifique */
        #reset-btn { 
            background-color: #d9534f; /* Rouge pour indiquer une action destructive */
            width: 100%; /* Occupe toute la largeur */
            margin-top: 20px;
            display: none; /* Caché par défaut */
            transition: opacity 0.3s ease;
            color: #fff;
            border-radius: 5px;
            padding: 10px;
        }

        /* Bouton de Bascule */
        #toggle-categories-btn {
            background-color: #b8860b; /* Jaune sombre */
            width: 100%; /* Occupe toute la largeur */
            margin-bottom: 20px;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top:15px;
        }
        #toggle-categories-btn:hover {
            background-color: #daa520; /* Or */
        }

        #blocks { margin-top: 10px; }
        .block { 
            padding: 15px; 
            margin: 10px 0; 
            background-color: #add8e6; 
            border-radius: 5px; 
            cursor: move; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            font-size: 1.1rem; 
            transition: opacity 0.3s, border 0.3s; 
            position: relative; /* Pour le drop-indicator */
        }
        .highlight { border: 2px solid #f56a79; }
        .custom-block { background-color: #ffcccb; }
        .block-content { flex-grow: 1; text-align: left; }
        .remove-btn, .edit-btn { 
            padding: 5px; 
            background-color: #f56a79; 
            color: #fff; 
            border: none; 
            border-radius: 3px; 
            cursor: pointer; 
            margin-left: 5px; 
        }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th, td { 
            padding: 8px; 
            text-align: left; 
            border: 1px solid #ccc; 
            cursor: pointer; 
        }
        th { background-color: #d3d3d3; }
        #download-btn { 
            width: 100%; 
            padding: 10px; 
            font-size: 1rem; 
            background-color: #4CAF50; 
            color: #fff; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-top: 10px;
        }
        .preview-content { 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            display: inline-block; 
            max-width: 100%; 
        }

        /* Popup Editor */
        #editor-modal {
            display: none; /* Masqué par défaut */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #editor-container {
            width: 80%;
            height: 80%;
            background: #fff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #editor-title {
            padding: 15px;
            background-color: #5f9ea0;
            color: #fff;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #ace-editor { 
            flex-grow: 1; 
            height: 100%; 
            width: 100%; 
            min-height: 0; /* Important pour Flexbox */
        }
        #editor-footer {
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            background: #eee;
        }
        #editor-footer button { margin-left: 10px; }

        /* Input Field for Name and Category */
        #editor-container .input-group {
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }
        #editor-container .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        #editor-container .input-group input[type="text"] {
            width: 100%;
            padding: 5px;
            font-size: 1rem;
        }
        #editor-container .input-group .category-group {
            margin-top: 10px;
        }
        #editor-container .input-group .category-group label {
            font-weight: normal;
            margin-right: 10px;
        }

        /* Drop Indicator */
        .drop-indicator {
            position: absolute;
            height: 2px;
            width: 100%;
            background-color: #f56a79;
            z-index: 500;
        }

        /* Preview Section */
        #generated-preview {
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            height: 400px;
            width: 100%;
            display: none; /* Caché par défaut */
            transition: opacity 0.3s ease;
        }
    </style>
    <!-- Charger Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
</head>
<body>
    <div id="builder">
        <h2>Fusko</h2>
        
        <div id="storage-explorer"></div>
        
        <!-- Bouton de Bascule des Catégories -->
        <button id="toggle-categories-btn" onclick="toggleCategories()">Display/Hide categories</button>

        <!-- Group HTML Buttons -->
        <div class="button-group" id="html-group">
            <h3>HTML</h3>
            <button class="btn-html" onclick="addBlock('HTML DOCTYPE')">DOCTYPE</button>
            <button class="btn-html" onclick="addBlock('HTML Lang')">Lang</button>
            <button class="btn-html" onclick="addBlock('HTML Title')">Title</button>
            <button class="btn-html" onclick="addBlock('HTML Meta')">Meta</button>
            <button class="btn-html" onclick="addBlock('HTML Header')">Header</button>
            <button class="btn-html" onclick="addBlock('HTML Footer')">Footer</button>
            <button class="btn-html" onclick="addBlock('HTML Nav')">Nav</button>
            <button class="btn-html" onclick="addBlock('HTML Section')">Section</button>
            <button class="btn-html" onclick="addBlock('HTML Article')">Article</button>
            <button class="btn-html" onclick="addBlock('HTML Aside')">Aside</button>
            <button class="btn-html" onclick="addBlock('HTML Main')">Main</button>
            <button class="btn-html" onclick="addBlock('HTML Form')">Form</button>
            <button class="btn-html" onclick="addBlock('HTML Input')">Input</button>
            <button class="btn-html" onclick="addBlock('HTML Textarea')">Textarea</button>
            <button class="btn-html" onclick="addBlock('HTML Select')">Select</button>
            <button class="btn-html" onclick="addBlock('HTML Option')">Option</button>
            <button class="btn-html" onclick="addBlock('HTML Button')">Button</button>
            <button class="btn-html" onclick="addBlock('HTML UL')">UL</button>
            <button class="btn-html" onclick="addBlock('HTML OL')">OL</button>
            <button class="btn-html" onclick="addBlock('HTML LI')">LI</button>
            <button class="btn-html" onclick="addBlock('HTML Table')">Table</button>
            <button class="btn-html" onclick="addBlock('HTML TR')">TR</button>
            <button class="btn-html" onclick="addBlock('HTML TH')">TH</button>
            <button class="btn-html" onclick="addBlock('HTML TD')">TD</button>
        </div>

        <!-- Group CSS Buttons -->
        <div class="button-group" id="css-group">
            <h3>CSS</h3>
            <button class="btn-css" onclick="addBlock('CSS Class')">Class</button>
            <button class="btn-css" onclick="addBlock('CSS ID')">ID</button>
            <button class="btn-css" onclick="addBlock('CSS Selector')">Selector</button>
            <button class="btn-css" onclick="addBlock('CSS Variable')">Variable</button>
            <button class="btn-css" onclick="addBlock('CSS Flexbox')">Flexbox</button>
            <button class="btn-css" onclick="addBlock('CSS Grid')">Grid</button>
            <button class="btn-css" onclick="addBlock('CSS Media Query')">Media Query</button>
            <button class="btn-css" onclick="addBlock('CSS Pseudo-class')">Pseudo-class</button>
            <button class="btn-css" onclick="addBlock('CSS Pseudo-element')">Pseudo-element</button>
            <button class="btn-css" onclick="addBlock('CSS Animation')">Animation</button>
            <button class="btn-css" onclick="addBlock('CSS Transition')">Transition</button>
            <button class="btn-css" onclick="addBlock('CSS Import')">Import</button>
            <button class="btn-css" onclick="addBlock('CSS Box Model')">Box Model</button>
            <button class="btn-css" onclick="addBlock('CSS Position')">Position</button>
        </div>

        <!-- Group JS Buttons -->
        <div class="button-group" id="js-group">
            <h3>JavaScript</h3>
            <button class="btn-js" onclick="addBlock('JS Script')">Script</button>
            <button class="btn-js" onclick="addBlock('JS Constant')">Constant</button>
            <button class="btn-js" onclick="addBlock('JS Variable')">Variable</button>
            <button class="btn-js" onclick="addBlock('JS Function')">Function</button>
            <button class="btn-js" onclick="addBlock('JS Class')">Class</button>
            <button class="btn-js" onclick="addBlock('JS Module')">Module</button>
            <button class="btn-js" onclick="addBlock('JS Event Listener')">Event Listener</button>
            <button class="btn-js" onclick="addBlock('JS DOM Manipulation')">DOM Manipulation</button>
            <button class="btn-js" onclick="addBlock('JS Fetch API')">Fetch API</button>
            <button class="btn-js" onclick="addBlock('JS Async Function')">Async Function</button>
            <button class="btn-js" onclick="addBlock('JS Promise')">Promise</button>
            <button class="btn-js" onclick="addBlock('JS Arrow Function')">Arrow Function</button>
            <button class="btn-js" onclick="addBlock('JS Array Methods')">Array Methods</button>
        </div>

        <!-- Custom Block Button -->
        <!-- <div class="button-group"  id="cs-group">
            <h3>Custom</h3>
            <button class="btn-custom" onclick="addBlock('Custom')">Custom Block</button>
        </div> -->

        <div id="blocks"></div>

        <!-- Bouton Reset -->
        <button id="reset-btn" onclick="resetBlocks()">Reset</button>
    </div>
    <div id="preview">
        <table id="htmlTable">
            <thead><tr><th>HTML Blocks</th></tr></thead>
            <tbody></tbody>
        </table>
        <table id="cssTable">
            <thead><tr><th>CSS Styles</th></tr></thead>
            <tbody></tbody>
        </table>
        <table id="jsTable">
            <thead><tr><th>JS Components</th></tr></thead>
            <tbody></tbody>
        </table>
        <button id="download-btn" onclick="downloadPage()">Download index.html</button>
        <iframe id="generated-preview" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>

    <!-- Popup Modal for Editing -->
    <div id="editor-modal">
        <div id="editor-container">
            <div id="editor-title">
                <span id="editor-title-text">Edit Component</span>
                <button onclick="closeEditor()">X</button>
            </div>
            <div class="input-group">
                <label for="block-name">Content (required):</label>
                <input type="text" id="block-name" placeholder="Enter component content">
            </div>
            <div class="input-group" id="category-group" style="display: none;">
                <label>Category (optional):</label>
                <div class="category-group">
                    <input type="radio" id="category-html" name="category" value="HTML">
                    <label for="category-html">HTML</label>
                    <input type="radio" id="category-css" name="category" value="CSS">
                    <label for="category-css">CSS</label>
                    <input type="radio" id="category-js" name="category" value="JS">
                    <label for="category-js">JS</label>
                </div>
            </div>
            <div id="ace-editor"></div>
            <div id="editor-footer">
                <button onclick="closeEditor()">Cancel</button>
                <button onclick="saveContent()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const blocksKey = 'pageBuilderBlocks'; // Clé pour localStorage
        let blocks = [];
        let currentEditingIndex = null;
        let draggedIndex = null;
        let categoriesVisible = true; // État des catégories

        // Initialisation de l'éditeur Ace
        const editor = ace.edit("ace-editor");
        editor.setTheme("ace/theme/github"); // Changement du thème à GitHub
        editor.session.setMode("ace/mode/javascript");
        editor.setOptions({
            fontSize: "14px",
            showPrintMargin: false
        });
        
        // Surveillence de données
        class StorageViewer {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    throw new Error('Container element not found');
                }
                
                this.init();
            }
        
            async init() {
                this.container.innerHTML = `
                    <div class="storage-viewer">
                        <div class="storage-section">
                            <h3>IndexedDB</h3>
                            <div id="idb-content"></div>
                        </div>
                        <div class="storage-section">
                            <h3>localStorage</h3>
                            <div id="ls-content"></div>
                        </div>
                        <div class="storage-section">
                            <h3>Cookies</h3>
                            <div id="cookies-content"></div>
                        </div>
                    </div>
                    <style>
                        .storage-viewer {
                            font-family: Arial, sans-serif;
                            padding: 10px;
                        }
                        .storage-section {
                            margin-bottom: 20px;
                            border: 1px solid #ddd;
                            padding: 10px;
                            border-radius: 4px;
                        }
                        .storage-section h3 {
                            margin-top: 0;
                            color: #333;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            text-align: left;
                        }
                        th {
                            background-color: #f5f5f5;
                        }
                    </style>
                `;
        
                await this.displayIndexedDB();
                this.displayLocalStorage();
                this.displayCookies();
            }
            
            
            async displayIndexedDB() {
                const idbContent = this.container.querySelector('#idb-content');
                try {
                    const databases = await window.indexedDB.databases();
                    let html = '<table><tr><th>Base de données</th><th>Contenu</th></tr>';
                    
                    for (const db of databases) {
                        const dbContent = await this.getIndexedDBContent(db.name);
                        html += `
                            <tr>
                                <td>${db.name}</td>
                                <td><pre>${JSON.stringify(dbContent, null, 2)}</pre></td>
                            </tr>
                        `;
                    }
                    
                    html += '</table>';
                    idbContent.innerHTML = databases.length ? html : 'Aucune base IndexedDB trouvée';
                } catch (error) {
                    idbContent.innerHTML = `Erreur lors de l'accès à IndexedDB: ${error.message}`;
                }
            }
        
            async getIndexedDBContent(dbName) {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(dbName);
                    const content = {};
        
                    request.onerror = () => reject(request.error);
                    request.onsuccess = async (event) => {
                        const db = event.target.result;
                        const objectStoreNames = Array.from(db.objectStoreNames);
                        
                        for (const storeName of objectStoreNames) {
                            const transaction = db.transaction(storeName, 'readonly');
                            const store = transaction.objectStore(storeName);
                            content[storeName] = await new Promise((resolve) => {
                                const items = [];
                                store.openCursor().onsuccess = (event) => {
                                    const cursor = event.target.result;
                                    if (cursor) {
                                        items.push({ key: cursor.key, value: cursor.value });
                                        cursor.continue();
                                    } else {
                                        resolve(items);
                                    }
                                };
                            });
                        }
                        resolve(content);
                        db.close();
                    };
                });
            }
        
            displayLocalStorage() {
                const lsContent = this.container.querySelector('#ls-content');
                try {
                    const items = Object.entries(localStorage);
                    if (items.length === 0) {
                        lsContent.innerHTML = 'localStorage est vide';
                        return;
                    }
        
                    let html = '<table><tr><th>Clé</th><th>Valeur</th></tr>';
                    items.forEach(([key, value]) => {
                        html += `
                            <tr>
                                <td>${key}</td>
                                <td><pre>${value}</pre></td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    lsContent.innerHTML = html;
                } catch (error) {
                    lsContent.innerHTML = `Erreur lors de l'accès au localStorage: ${error.message}`;
                }
            }
        
            displayCookies() {
                const cookiesContent = this.container.querySelector('#cookies-content');
                try {
                    const cookies = document.cookie.split(';').map(cookie => {
                        const [key, value] = cookie.trim().split('=');
                        return { key, value };
                    }).filter(cookie => cookie.key);
        
                    if (cookies.length === 0) {
                        cookiesContent.innerHTML = 'Aucun cookie trouvé';
                        return;
                    }
        
                    let html = '<table><tr><th>Nom</th><th>Valeur</th></tr>';
                    cookies.forEach(({ key, value }) => {
                        html += `
                            <tr>
                                <td>${key}</td>
                                <td>${value}</td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    cookiesContent.innerHTML = html;
                } catch (error) {
                    cookiesContent.innerHTML = `Erreur lors de l'accès aux cookies: ${error.message}`;
                }
            }
        }

        // Fonction pour échapper les caractères spéciaux en HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Charger les blocs depuis localStorage au chargement de la page
        window.onload = function() {
            const savedBlocks = localStorage.getItem(blocksKey);
            if (savedBlocks) {
                try {
                    blocks = JSON.parse(savedBlocks);
                } catch (e) {
                    console.error("Erreur lors de la récupération des blocs depuis localStorage:", e);
                    blocks = [];
                }
            }
            renderBlocks();
            updateTables();
            updatePreview(); // Mettre à jour l'aperçu au chargement
            toggleResetButton(); // Mettre à jour la visibilité du bouton Reset
            togglePreview(); // Mettre à jour la visibilité de l'aperçu
        };

        // Sauvegarder les blocs dans localStorage
        function saveBlocks() {
            localStorage.setItem(blocksKey, JSON.stringify(blocks));
        }

        // Ajouter un nouveau bloc
        function addBlock(type) {
            const block = {
                type,
                title: '', // Nom du bloc (facultatif)
                content: getDefaultContent(type),
                isCustom: type === 'Custom',
                category: type === 'Custom' ? null : null // Catégorie par défaut pour les Custom Blocks est null
            };
            blocks.push(block);
            renderBlocks();
            updateTables();
            saveBlocks();
            updatePreview(); // Mettre à jour l'aperçu après l'ajout
            toggleResetButton(); // Mettre à jour la visibilité du bouton Reset
            togglePreview(); // Mettre à jour la visibilité de l'aperçu
        }

        // Obtenir le contenu par défaut en fonction du type
        function getDefaultContent(type) {
            const defaults = {
                'HTML DOCTYPE': '<!DOCTYPE html>',
                'HTML Lang': '<html lang="en" />', // Valeur par défaut pour Lang
                'HTML Title': '<title>My Page</title>',
                'HTML Meta': '<meta charset="UTF-8">',
                'HTML Header': '<header>Header Content</header>',
                'HTML Footer': '<footer>Footer Content</footer>',
                'HTML Nav': '<nav>Navigation Links</nav>',
                'HTML Section': '<section>Section Content</section>',
                'HTML Article': '<article>Article Content</article>',
                'HTML Aside': '<aside>Aside Content</aside>',
                'HTML Main': '<main>Main Content</main>',
                'HTML Form': '<form action="#" method="post">Form Content</form>',
                'HTML Input': '<input type="text" placeholder="Enter text">',
                'HTML Textarea': '<textarea placeholder="Enter text"></textarea>',
                'HTML Select': '<select><option value="option1">Option 1</option></select>',
                'HTML Option': '<option value="option1">Option 1</option>',
                'HTML Button': '<button>Click me</button>',
                'HTML UL': '<ul><li>Item 1</li></ul>',
                'HTML OL': '<ol><li>Item 1</li></ol>',
                'HTML LI': '<li>List Item</li>',
                'HTML Table': '<table><tr><th>Header</th></tr></table>',
                'HTML TR': '<tr><td>Data</td></tr>',
                'HTML TH': '<th>Header</th>',
                'HTML TD': '<td>Data</td>',
                'CSS Class': '.my-class { color: red; }',
                'CSS ID': '#my-id { font-size: 16px; }',
                'CSS Selector': 'p { margin-bottom: 10px; }',
                'CSS Variable': '--main-color: #3498db;',
                'CSS Flexbox': 'display: flex; justify-content: center; align-items: center;',
                'CSS Grid': 'display: grid; grid-template-columns: repeat(3, 1fr);',
                'CSS Media Query': '@media (max-width: 600px) { body { background-color: lightgreen; } }',
                'CSS Pseudo-class': 'a:hover { color: blue; }',
                'CSS Pseudo-element': 'p::first-letter { font-size: 2em; }',
                'CSS Animation': '@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }',
                'CSS Transition': 'transition: all 0.3s ease;',
                'CSS Import': '@import url("styles.css");',
                'CSS Box Model': 'div { padding: 10px; margin: 5px; border: 1px solid #000; }',
                'CSS Position': 'position: absolute; top: 50px; left: 100px;',
                'JS Script': '<!-- <script>console.log("Script component loaded");<\/script> -->\n<script src="https://MYCDN.com"><\/script>',
                'JS Constant': 'const myConstant = "Hello World";',
                'JS Variable': 'let myVariable = 10;',
                'JS Function': 'function myFunction() { return true; }',
                'JS Class': 'class MyClass { constructor() { this.name = "MyClass"; } }',
                'JS Module': 'export function myModuleFunction() { console.log("Module Function"); }',
                'JS Event Listener': 'document.getElementById("myButton").addEventListener("click", function() { alert("Button Clicked!"); });',
                'JS DOM Manipulation': 'const div = document.createElement("div"); div.textContent = "New Div"; document.body.appendChild(div);',
                'JS Fetch API': 'fetch("https://api.example.com/data").then(response => response.json()).then(data => console.log(data));',
                'JS Async Function': 'async function fetchData() { const response = await fetch("https://api.example.com/data"); const data = await response.json(); console.log(data); }',
                'JS Promise': 'const myPromise = new Promise((resolve, reject) => { setTimeout(() => { resolve("Promise Resolved"); }, 1000); });',
                'JS Arrow Function': 'const myArrowFunction = () => { console.log("Arrow Function"); };',
                'JS Array Methods': 'const arr = [1, 2, 3]; const doubled = arr.map(num => num * 2);'
            };
            return defaults[type] || '';
        }

        // Rendre les blocs dans le builder
        function renderBlocks() {
            const blocksDiv = document.getElementById('blocks');
            blocksDiv.innerHTML = '';
            blocks.forEach((block, index) => {
                const div = document.createElement('div');
                div.className = 'block' + (block.isCustom ? ' custom-block' : '');
                div.id = `block-${index}`; // Assignation d'un ID unique
                div.draggable = true;
                div.ondragstart = (e) => dragStart(e, index, div);
                div.ondragenter = (e) => dragEnter(e, index);
                div.ondragover = (e) => e.preventDefault();
                div.ondragleave = dragLeave;
                div.ondrop = (e) => drop(e, index, div);
                div.innerHTML = `
                    <div class="block-content">${escapeHtml(block.title || block.type)}</div>
                    <button class="edit-btn" onclick="openEditor(${index})">Edit</button>
                    <button class="remove-btn" onclick="removeBlock(${index})">X</button>
                `;
                blocksDiv.appendChild(div);
            });
        }

        // Mettre à jour les tableaux de prévisualisation
        function updateTables() {
            const htmlBlocks = [];
            const cssBlocks = [];
            const jsBlocks = [];
            blocks.forEach((block, index) => {
                let displayTitle = block.title || block.type;
                if (block.isCustom) {
                    // Pour les Custom Blocks, inclure la catégorie si définie
                    displayTitle = block.title || (block.category ? `${block.type} (${block.category})` : block.type);
                }
                if (['HTML DOCTYPE', 'HTML Lang', 'HTML Title', 'HTML Meta', 'HTML Header', 'HTML Footer', 'HTML Nav', 'HTML Section', 'HTML Article', 'HTML Aside', 'HTML Main', 'HTML Form', 'HTML Input', 'HTML Textarea', 'HTML Select', 'HTML Option', 'HTML Button', 'HTML UL', 'HTML OL', 'HTML LI', 'HTML Table', 'HTML TR', 'HTML TH', 'HTML TD'].includes(block.type) || (block.isCustom && block.category === 'HTML')) {
                    htmlBlocks.push({ title: displayTitle, index });
                }
                if (['CSS Class', 'CSS ID', 'CSS Selector', 'CSS Variable', 'CSS Flexbox', 'CSS Grid', 'CSS Media Query', 'CSS Pseudo-class', 'CSS Pseudo-element', 'CSS Animation', 'CSS Transition', 'CSS Import', 'CSS Box Model', 'CSS Position'].includes(block.type) || (block.isCustom && block.category === 'CSS')) {
                    cssBlocks.push({ title: displayTitle, index });
                }
                if (['JS Script', 'JS Constant', 'JS Variable', 'JS Function', 'JS Class', 'JS Module', 'JS Event Listener', 'JS DOM Manipulation', 'JS Fetch API', 'JS Async Function', 'JS Promise', 'JS Arrow Function', 'JS Array Methods'].includes(block.type) || (block.isCustom && block.category === 'JS')) {
                    jsBlocks.push({ title: displayTitle, index });
                }
            });
            populateTable('htmlTable', htmlBlocks);
            populateTable('cssTable', cssBlocks);
            populateTable('jsTable', jsBlocks);
        }

        // Remplir un tableau avec des données
        function populateTable(tableId, data) {
            const tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.className = 'preview-content';
                cell.textContent = item.title;
                cell.onclick = () => {
                    highlightBlock(item.index); // Mettre en surbrillance le bloc à gauche
                };
                row.appendChild(cell);
                tbody.appendChild(row);
            });
        }

        // Mettre à jour l'aperçu de index.html
        function updatePreview() {
            const generatedHTML = generateHTML();
            const iframe = document.getElementById('generated-preview');
            if (blocks.length > 0) {
                iframe.srcdoc = generatedHTML;
                iframe.style.display = 'block';
            } else {
                iframe.srcdoc = '';
                iframe.style.display = 'none';
            }
        }

        // Générer le contenu HTML
        function generateHTML() {
            let html = '';
            // Extraire les blocs DOCTYPE et Lang
            let doctype = '<!DOCTYPE html>';
            let lang = '<html lang="en">';
            const doctypeBlocks = blocks.filter(block => block.type === 'HTML DOCTYPE');
            if (doctypeBlocks.length > 0) {
                doctype = doctypeBlocks[0].content || '<!DOCTYPE html>';
            }
            const langBlocks = blocks.filter(block => block.type === 'HTML Lang');
            if (langBlocks.length > 0) {
                lang = langBlocks[0].content || '<html lang="en">';
            }
            html += `${doctype}\n`;
            html += `${lang}\n`;
            html += `<head>\n`;
        
            // Parcourir les blocs pour le head (HTML, CSS, JS)
            blocks.forEach(block => {
                if (block.type === 'HTML DOCTYPE' || block.type === 'HTML Lang') {
                    // DOCTYPE et Lang sont gérés séparément
                    return;
                }
                
                else if (block.type.startsWith('CSS ')) {
                    html += `<style>\n${block.content}\n</style>\n`;
                } 
                
                else if (block.type === 'JS CDN') {
                    // Ajouter les CDN dans le head
                    html += `${block.content}\n`;
                }
            });
        
            html += `</head>\n`;
            html += `<body>\n`;
        
            // Parcourir les blocs pour le contenu du body (HTML)
            blocks.forEach(block => {
                if (block.type.startsWith('HTML ')) {
                    // Exclure DOCTYPE et Lang qui sont dans head
                    if (['HTML DOCTYPE', 'HTML Lang'].includes(block.type)) return;
                    html += `${block.content}\n`;
                }
            });
        
            html += `</body>\n`;
            html += `</html>\n`;
            return html;
        }

        // Mettre en surbrillance un bloc spécifique
        function highlightBlock(index) {
            const blocksDiv = document.getElementById('blocks');
            // Retirer la classe highlight de tous les blocs
            Array.from(blocksDiv.children).forEach(child => {
                child.classList.remove('highlight');
            });
            // Ajouter la classe highlight au bloc sélectionné
            const selectedBlock = document.getElementById(`block-${index}`);
            if (selectedBlock) {
                selectedBlock.classList.add('highlight');
                selectedBlock.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }

        // Ouvrir le popup d'édition pour un bloc spécifique
        function openEditor(index) {
            currentEditingIndex = index;
            const block = blocks[index];
            document.getElementById('editor-title-text').textContent = `Edit ${block.type} Component`;
            document.getElementById('block-name').value = block.type.startsWith('HTML Lang') ? block.content : block.title;
            if (block.type === 'HTML Lang') {
                document.getElementById('block-name').placeholder = 'e.g., <html lang="en" />';
            } else {
                document.getElementById('block-name').placeholder = 'Enter component name';
            }
            editor.session.setValue(block.content.startsWith('<') ? block.content : block.content);
            
            // Afficher ou masquer le groupe de catégories en fonction du type du bloc
            const categoryGroup = document.getElementById('category-group');
            if (block.isCustom) {
                categoryGroup.style.display = 'block';
                // Cocher la catégorie actuelle si définie, sinon laisser aucune sélection
                if (block.category) {
                    document.querySelector(`input[name="category"][value="${block.category}"]`).checked = true;
                } else {
                    // Aucun bouton radio sélectionné par défaut si catégorie est null
                    document.querySelectorAll('input[name="category"]').forEach(radio => radio.checked = false);
                }
            } else {
                categoryGroup.style.display = 'none';
            }
            
            document.getElementById('editor-modal').style.display = 'flex';
            
            // Utiliser requestAnimationFrame pour s'assurer que le DOM est rendu
            requestAnimationFrame(() => {
                editor.resize(); // Ajuster la taille de l'éditeur Ace après l'affichage
            });
        }

        // Fermer le popup d'édition
        function closeEditor() {
            document.getElementById('editor-modal').style.display = 'none';
        }

        // Sauvegarder le contenu édité dans le bloc
        function saveContent() {
            if (currentEditingIndex !== null) {
                const newContent = document.getElementById('block-name').value.trim();
                const block = blocks[currentEditingIndex];
                if (block.type === 'HTML Lang') {
                    // Pour Lang, le contenu est directement l'attribut lang
                    blocks[currentEditingIndex].content = newContent || 'en'; // Utilisez 'en' si vide
                } else {
                    // Si le nom est vide, utiliser le type comme nom par défaut
                    const finalTitle = newContent !== '' ? newContent : block.type;
                    blocks[currentEditingIndex].title = finalTitle;
                    blocks[currentEditingIndex].content = editor.session.getValue();
                    if (blocks[currentEditingIndex].isCustom) {
                        const selectedCategory = document.querySelector('input[name="category"]:checked');
                        blocks[currentEditingIndex].category = selectedCategory ? selectedCategory.value : null;
                    }
                }
                renderBlocks();
                updateTables();
                saveBlocks();
                updatePreview(); // Mettre à jour l'aperçu après la sauvegarde
                toggleResetButton(); // Mettre à jour la visibilité du bouton Reset
                togglePreview(); // Mettre à jour la visibilité de l'aperçu
                closeEditor();
            }
        }

        // Fonction appelée au démarrage du drag
        function dragStart(e, index, element) {
            draggedIndex = index;
            element.style.opacity = 0.5; // Rendre l'élément quasi transparent
            e.dataTransfer.effectAllowed = 'move';
        }

        // Fonction appelée lors de l'entrée dans un autre bloc pendant le drag
        function dragEnter(e, index) {
            const blocksDiv = document.getElementById('blocks');
            let indicator = document.querySelector('.drop-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.classList.add('drop-indicator');
                blocksDiv.appendChild(indicator);
            }
            const targetBlock = blocksDiv.children[index];
            const topRelative = targetBlock.offsetTop;
            if (index > draggedIndex) {
                indicator.style.top = `${topRelative + targetBlock.offsetHeight}px`;
            } else {
                indicator.style.top = `${topRelative}px`;
            }
            indicator.style.left = '0';
            indicator.style.width = '100%';
            indicator.style.display = 'block';
        }

        // Fonction appelée lorsque le drag quitte un bloc
        function dragLeave(e) {
            const indicator = document.querySelector('.drop-indicator');
            if (indicator) indicator.style.display = 'none';
        }

        // Fonction appelée lors du drop d'un bloc
        function drop(e, dropIndex, element) {
            e.preventDefault();
            const indicator = document.querySelector('.drop-indicator');
            if (indicator) indicator.style.display = 'none';
            if (draggedIndex === null) return;
            const draggedBlock = blocks.splice(draggedIndex, 1)[0];
            blocks.splice(dropIndex, 0, draggedBlock);
            renderBlocks();
            updateTables();
            saveBlocks();
            updatePreview(); // Mettre à jour l'aperçu après le drop
            toggleResetButton(); // Mettre à jour la visibilité du bouton Reset
            togglePreview(); // Mettre à jour la visibilité de l'aperçu
        }

        // Supprimer un bloc
        function removeBlock(index) {
            if (confirm("Voulez-vous vraiment supprimer ce bloc ?")) {
                blocks.splice(index, 1);
                renderBlocks();
                updateTables();
                saveBlocks();
                updatePreview(); // Mettre à jour l'aperçu après la suppression
                toggleResetButton(); // Mettre à jour la visibilité du bouton Reset
                togglePreview(); // Mettre à jour la visibilité de l'aperçu
            }
        }

        // Télécharger la page HTML générée
        function downloadPage() {
            let html = '';
            // Générer le HTML
            html = generateHTML();

            const blob = new Blob([html], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'index.html';
            link.click();

            updatePreview(); // Mettre à jour l'aperçu après le téléchargement
        }

        // Fonction pour réinitialiser tous les blocs
        function resetBlocks() {
            if (confirm("Êtes-vous sûr de vouloir réinitialiser tous les composants ? Cette action est irréversible.")) {
                blocks = [];
                renderBlocks();
                updateTables();
                saveBlocks();
                updatePreview(); // Mettre à jour l'aperçu après la réinitialisation
                toggleResetButton(); // Mettre à jour la visibilité du bouton Reset
                togglePreview(); // Mettre à jour la visibilité de l'aperçu
            }
        }

        // Fonction pour basculer la visibilité du bouton Reset
        function toggleResetButton() {
            const resetBtn = document.getElementById('reset-btn');
            if (blocks.length > 1) {
                resetBtn.style.display = 'block';
            } else {
                resetBtn.style.display = 'none';
            }
        }

        // Fonction pour basculer la visibilité de l'aperçu
        function togglePreview() {
            const iframe = document.getElementById('generated-preview');
            if (blocks.length > 0) {
                iframe.style.display = 'block';
            } else {
                iframe.style.display = 'none';
            }
        }

        // Fonction pour basculer la visibilité des catégories et de leurs boutons
        function toggleCategories() {
            categoriesVisible = !categoriesVisible;
            document.getElementById('html-group').style.display = categoriesVisible ? 'block' : 'none';
            document.getElementById('css-group').style.display = categoriesVisible ? 'block' : 'none';
            document.getElementById('js-group').style.display = categoriesVisible ? 'block' : 'none';
            document.getElementById('cs-group').style.display = categoriesVisible ? 'block' : 'none';
        }
        
        
 class StorageExplorer {
    constructor(containerId) {
        this.container = document.getElementById(containerId);
        if (!this.container) {
            throw new Error('Container element not found');
        }
        
        this.init();
        this.addStyles();
    }

    async init() {
        // Structure principale
        this.container.innerHTML = `
            <div class="storage-kpis">
                <div class="kpi-card" data-type="indexeddb">
                    <h3>IndexedDB</h3>
                    <div class="kpi-value">...</div>
                    <div class="kpi-label">Bases de données</div>
                </div>
                <div class="kpi-card" data-type="localstorage">
                    <h3>localStorage</h3>
                    <div class="kpi-value">...</div>
                    <div class="kpi-label">Entrées</div>
                </div>
                <div class="kpi-card" data-type="cookies">
                    <h3>Cookies</h3>
                    <div class="kpi-value">...</div>
                    <div class="kpi-label">Cookies actifs</div>
                </div>
            </div>

            <div class="storage-modal" id="storageModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Explorateur de stockage</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-nav">
                        <button class="nav-btn active" data-view="indexeddb">IndexedDB</button>
                        <button class="nav-btn" data-view="localstorage">localStorage</button>
                        <button class="nav-btn" data-view="cookies">Cookies</button>
                    </div>
                    <div class="modal-body"></div>
                </div>
            </div>
        `;

        // Initialiser les événements
        this.initializeEvents();
        
        // Charger les données initiales
        await this.refreshKPIs();
    }

    addStyles() {
        const styles = `
            .storage-kpis {
                display: flex;
                gap: 20px;
                flex-wrap: wrap;
            }

            .kpi-card {
                flex: 1;
                min-width: 200px;
                padding: 20px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                cursor: pointer;
                transition: transform 0.2s;
            }

            .kpi-card:hover {
                transform: translateY(-2px);
            }

            .kpi-card h3 {
                margin: 0;
                color: #333;
                font-size: 16px;
            }

            .kpi-value {
                font-size: 28px;
                font-weight: bold;
                margin: 10px 0;
                color: #2196F3;
            }

            .kpi-label {
                color: #666;
                font-size: 14px;
            }

            .storage-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
            }

            .modal-content {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                width: 90%;
                max-width: 800px;
                max-height: 90vh;
                border-radius: 10px;
                display: flex;
                flex-direction: column;
            }

            .modal-header {
                padding: 20px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-header h2 {
                margin: 0;
                font-size: 20px;
            }

            .close-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
            }

            .modal-nav {
                display: flex;
                gap: 10px;
                padding: 10px 20px;
                border-bottom: 1px solid #eee;
                overflow-x: auto;
            }

            .nav-btn {
                padding: 8px 16px;
                border: none;
                background: none;
                cursor: pointer;
                border-radius: 20px;
                white-space: nowrap;
            }

            .nav-btn.active {
                background: #2196F3;
                color: white;
            }

            .modal-body {
                padding: 20px;
                overflow-y: auto;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th, td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #eee;
            }

            th {
                background: #f5f5f5;
                font-weight: bold;
            }

            @media (max-width: 600px) {
                .kpi-card {
                    min-width: 100%;
                }
                
                .modal-content {
                    width: 100%;
                    height: 100%;
                    max-height: 100vh;
                    border-radius: 0;
                }
                
                .modal-body {
                    padding: 10px;
                }
                
                th, td {
                    padding: 8px;
                }
            }
        `;

        const styleElement = document.createElement('style');
        styleElement.textContent = styles;
        document.head.appendChild(styleElement);
    }

    initializeEvents() {
        // Événements pour les cartes KPI
        this.container.querySelectorAll('.kpi-card').forEach(card => {
            card.addEventListener('click', () => {
                this.openModal(card.dataset.type);
            });
        });

        // Événements pour le modal
        const modal = this.container.querySelector('#storageModal');
        modal.querySelector('.close-btn').addEventListener('click', () => {
            modal.style.display = 'none';
        });

        modal.querySelector('.modal-nav').addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-btn')) {
                this.showView(e.target.dataset.view);
                modal.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });

        // Fermer le modal en cliquant en dehors
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    async refreshKPIs() {
        // IndexedDB KPI
        const databases = await window.indexedDB.databases();
        this.updateKPIValue('indexeddb', databases.length);

        // localStorage KPI
        const lsCount = Object.keys(localStorage).length;
        this.updateKPIValue('localstorage', lsCount);

        // Cookies KPI
        const cookiesCount = document.cookie.split(';').filter(cookie => cookie.trim()).length;
        this.updateKPIValue('cookies', cookiesCount);
    }

    updateKPIValue(type, value) {
        const kpiCard = this.container.querySelector(`[data-type="${type}"] .kpi-value`);
        if (kpiCard) {
            kpiCard.textContent = value;
        }
    }

    async openModal(type) {
        const modal = this.container.querySelector('#storageModal');
        modal.style.display = 'block';
        
        // Activer le bon onglet
        modal.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === type);
        });

        await this.showView(type);
    }

    async showView(type) {
        const modalBody = this.container.querySelector('.modal-body');
        modalBody.innerHTML = 'Chargement...';

        switch (type) {
            case 'indexeddb':
                await this.showIndexedDBView(modalBody);
                break;
            case 'localstorage':
                this.showLocalStorageView(modalBody);
                break;
            case 'cookies':
                this.showCookiesView(modalBody);
                break;
        }
    }

    async showIndexedDBView(container) {
        try {
            const databases = await window.indexedDB.databases();
            if (databases.length === 0) {
                container.innerHTML = 'Aucune base IndexedDB trouvée';
                return;
            }

            let html = '<div class="idb-explorer">';
            for (const db of databases) {
                const content = await this.getIndexedDBContent(db.name);
                html += `
                    <div class="db-section">
                        <h3>${db.name}</h3>
                        ${this.formatObjectStores(content)}
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        } catch (error) {
            container.innerHTML = `Erreur: ${error.message}`;
        }
    }

    formatObjectStores(content) {
        let html = '';
        for (const [storeName, items] of Object.entries(content)) {
            html += `
                <div class="store-section">
                    <h4>${storeName}</h4>
                    <table>
                        <tr>
                            <th>Clé</th>
                            <th>Valeur</th>
                        </tr>
                        ${items.map(item => `
                            <tr>
                                <td>${item.key}</td>
                                <td><pre>${JSON.stringify(item.value, null, 2)}</pre></td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;
        }
        return html;
    }

    showLocalStorageView(container) {
        const items = Object.entries(localStorage);
        if (items.length === 0) {
            container.innerHTML = 'localStorage est vide';
            return;
        }

        container.innerHTML = `
            <table>
                <tr>
                    <th>Clé</th>
                    <th>Valeur</th>
                </tr>
                ${items.map(([key, value]) => `
                    <tr>
                        <td>${key}</td>
                        <td><pre>${value}</pre></td>
                    </tr>
                `).join('')}
            </table>
        `;
    }

    showCookiesView(container) {
        const cookies = document.cookie.split(';')
            .map(cookie => {
                const [key, value] = cookie.trim().split('=');
                return { key, value };
            })
            .filter(cookie => cookie.key);

        if (cookies.length === 0) {
            container.innerHTML = 'Aucun cookie trouvé';
            return;
        }

        container.innerHTML = `
            <table>
                <tr>
                    <th>Nom</th>
                    <th>Valeur</th>
                </tr>
                ${cookies.map(cookie => `
                    <tr>
                        <td>${cookie.key}</td>
                        <td>${cookie.value}</td>
                    </tr>
                `).join('')}
            </table>
        `;
    }

    async getIndexedDBContent(dbName) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName);
            const content = {};

            request.onerror = () => reject(request.error);
            request.onsuccess = async (event) => {
                const db = event.target.result;
                const objectStoreNames = Array.from(db.objectStoreNames);
                
                for (const storeName of objectStoreNames) {
                    const transaction = db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    content[storeName] = await new Promise((resolve) => {
                        const items = [];
                        store.openCursor().onsuccess = (event) => {
                            const cursor = event.target.result;
                            if (cursor) {
                                items.push({ key: cursor.key, value: cursor.value });
                                cursor.continue();
                            } else {
                                resolve(items);
                            }
                        };
                    });
                }
                resolve(content);
                db.close();
            };
        });
    }
}       
const explorer = new StorageExplorer('storage-explorer');
    </script>
</body>
</html>
